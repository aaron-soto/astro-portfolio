---
import BlogLayout from "../components/BlogLayout.astro";
import { getAllTags, safeDate, slugify } from "../lib/utils";
import {
  initCmsHelper,
  getModuleDataBySlug,
  type CMSCache,
} from "ayezee-astro-cms";
import cmsData from "../data/cms-cache.json";

// Initialize CMS helper
initCmsHelper(cmsData as CMSCache);

// Get blog posts from CMS
const cmsBlogData = getModuleDataBySlug("blog");

// Transform CMS data to match the expected format
const blogPosts = cmsBlogData.map((item) => {
  const data = item.data as Record<string, any>;
  const pubDate = safeDate(data.pubDate || item.createdAt);
  const updatedDate = item.updatedAt ? safeDate(item.updatedAt) : undefined;
  const generatedSlug = data.slug || slugify(data.title || item.id);

  return {
    id: item.id,
    slug: generatedSlug,
    body: data.content || "",
    data: {
      title: data.title || "Untitled",
      slug: generatedSlug, // Add slug to data object for BlogGrid component
      description: data.excerpt || data.description || "",
      pubDate,
      updatedDate,
      heroImage: data.featured_image || data.heroImage,
      heroAlt: data.heroAlt || `${data.title} hero image`,
      tags: data.category ? [data.category] : [], // Use category field as a single tag
    },
  };
});

const allTags = getAllTags(blogPosts);
---

<BlogLayout allTags={allTags} posts={blogPosts} />
