---
import Layout from "../../layouts/Layout.astro";
import WorkLayout from "../../components/WorkLayout.astro";
import ExternalLink from "../../components/icons/ExternalLink.astro";
import { initCmsHelper, getModuleDataBySlug } from "ayezee-astro-cms";
import cmsData from "../../data/cms-cache.json";
import { highlightCodeBlocks } from "../../lib/highlight-code";
import { getAllCategories } from "../../lib/utils";

// Initialize CMS helper
initCmsHelper(cmsData);

export async function getStaticPaths() {
  const cmsWorkData = getModuleDataBySlug("work");

  // Transform CMS data to match expected format
  const workPosts = cmsWorkData.map((item) => {
    const data = item.data as Record<string, any>;

    return {
      id: item.id,
      slug: data.slug || item.id,
      data: {
        title: data.title || "Untitled",
        slug: data.slug || item.id,
        description: data.description || "",
        category: data.category || "",
        heroImage: data.featured_image || "",
        url: data.project_url || "",
        logo: data.logo || "",
        metaTitle: data.title || "Untitled",
        metaDescription: data.description || "",
      },
      rawData: data,
    };
  });

  const allCategories = getAllCategories(workPosts);
  const paths = [];

  // Generate category pages
  allCategories.forEach((category) => {
    const filteredPosts = workPosts.filter(
      (post) => post.data.category === category
    );
    paths.push({
      params: { slug: category.toLowerCase() },
      props: {
        isCategory: true,
        category,
        posts: filteredPosts,
        item: null,
      },
    });
  });

  // Generate individual work item pages
  cmsWorkData.forEach((item) => {
    const data = item.data as Record<string, any>;
    const slug = data.slug || item.id;

    // Only add if slug doesn't conflict with a category
    if (!allCategories.some(cat => cat.toLowerCase() === slug.toLowerCase())) {
      paths.push({
        params: { slug },
        props: {
          isCategory: false,
          category: null,
          posts: null,
          item,
        },
      });
    }
  });

  return paths;
}

const { isCategory, item, category, posts } = Astro.props;

// Prepare data for individual posts
const data = isCategory ? null : (item.data as Record<string, any>);
const highlightedContent = isCategory ? null : await highlightCodeBlocks(data.content || "");

if (!isCategory && !item) {
  return Astro.redirect("/404");
}
---

{isCategory ? (
  <WorkLayout currentCategory={category} posts={posts} />
) : (
  <Layout
    title={data.title || "Untitled"}
    description={data.description || ""}
  >
    <div class="relative">
      <div class="container relative pt-6 flex flex-col">
        {
          data.logo ? (
            <div class="bg-white aspect-square size-44 mb-6 grid place-items-center">
              <img
                src={data.logo}
                alt={`${data.title} logo`}
                class="size-44 object-contain group-hover:scale-110 transition-transform duration-300"
              />
            </div>
          ) : data.featured_image ? (
            <div class="mb-6 max-w-3xl">
              <img
                src={data.featured_image}
                alt={`${data.title} hero image`}
                class="w-full object-cover"
              />
            </div>
          ) : null
        }
        <div>
          <h1 class="text-3xl! md:text-5xl! font-bold mb-4 bg-linear-to-br">
            {data.title}
          </h1>
          <p class="text-lg text-neutral-300 leading-relaxed max-w-prose">
            {data.description}
          </p>

          {
            data.project_url && (
              <div class="pt-6">
                <a
                  href={data.project_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center gap-2 hover:text-primary w-full md:max-w-[25%] bg-black hover:bg-neutral-950 border border-lines py-2.5 px-4 transition-colors"
                >
                  <span class="">View Live Website</span>
                  <ExternalLink class="size-5" />
                </a>
              </div>
            )
          }
        </div>
      </div>
    </div>

    <div class="container content-sections pb-20 grid-cols-4 md:grid-cols-8">
      <div set:html={highlightedContent} />
    </div>
  </Layout>
)}

<style>
  html {
    scroll-behavior: smooth;
  }

  .content-sections :global(h2) {
    color: var(--color-primary);
    font-size: 2.5rem;
    line-height: 1.2;
    margin-top: 4rem;
    padding-bottom: 1rem;
    font-weight: 700;
    position: relative;
    scroll-margin-top: 100px;
  }
  .content-sections :global(h3) {
    color: var(--color-foreground);
    font-size: 1.75rem;
    line-height: 1.3;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    font-weight: 600;
    position: relative;
    padding-left: 1.5rem;
  }

  .content-sections :global(h3::before) {
    content: "";
    position: absolute;
    left: 0;
    top: 0.5rem;
    width: 4px;
    height: 1.5rem;
    background: var(--color-primary);
    border-radius: 2px;
  }

  .content-sections :global(p) {
    color: var(--color-foreground-muted);
    line-height: 1.7;
    margin-bottom: 1.5rem;
    text-align: justify;
    max-width: 680px;
  }

  .content-sections :global(p:first-of-type) {
    color: var(--color-foreground);
    font-weight: 500;
  }

  .content-sections :global(ul),
  .content-sections :global(ol) {
    margin: 2rem 0;
    padding-left: 0;
  }

  .content-sections :global(li) {
    color: var(--color-foreground-muted);
    font-size: 1.125rem;
    line-height: 1.7;
    margin-bottom: 1rem;
    position: relative;
    padding-left: 2rem;
  }

  .content-sections :global(li strong) {
    color: var(--color-primary);
    font-weight: 600;
    display: block;
    margin-bottom: 0.25rem;
  }

  .content-sections :global(img) {
    width: 100%;
    height: auto;
    transition: all 0.3s ease;
    border: 1px solid var(--color-lines);
  }

  .content-sections :global(img.full-width) {
    width: 75%;
  }

  .content-sections :global(blockquote) {
    background: rgba(255, 255, 255, 0.03);
    border-left: 4px solid var(--color-primary);
    border-radius: 0 8px 8px 0;
    padding: 2rem;
    margin: 3rem 0;
    font-style: italic;
    font-size: 1.25rem;
    line-height: 1.6;
    position: relative;
  }

  .content-sections :global(blockquote::before) {
    content: '"';
    position: absolute;
    top: -0.5rem;
    left: 1rem;
    font-size: 4rem;
    color: var(--color-primary);
    opacity: 0.3;
  }

  .content-sections :global(pre) {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--color-lines);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    overflow-x: auto;
    position: relative;
    backdrop-filter: blur(10px);
  }

  .content-sections :global(pre::before) {
    content: "";
    position: absolute;
    top: 1rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background: #ff5f56;
    border-radius: 50%;
    box-shadow:
      20px 0 #ffbd2e,
      40px 0 #27ca3f;
  }

  .content-sections :global(code) {
    background: rgba(255, 255, 255, 0.1);
    color: var(--color-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.9em;
    font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
  }

  .content-sections :global(pre code) {
    background: none;
    padding: 0;
    color: var(--color-foreground);
  }

  @media (max-width: 768px) {
    .content-sections :global(h3) {
      padding-left: 0;
    }

    .content-sections :global(h3::before) {
      display: none;
    }

    .content-sections :global(img.full-width) {
      width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
  }
</style>
