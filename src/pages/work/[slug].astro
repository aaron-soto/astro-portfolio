---
import Layout from "../../layouts/Layout.astro";
import WorkLayout from "../../components/WorkLayout.astro";
import ExternalLink from "../../components/icons/ExternalLink.astro";
import {
  initCmsHelper,
  getModuleDataBySlug,
  type CMSCache,
} from "ayezee-astro-cms";
import cmsData from "../../data/cms-cache.json";
import { highlightCodeBlocks } from "../../lib/highlight-code";
import { getAllCategories, slugify } from "../../lib/utils";
import "../../styles/content-sections.css";

export async function getStaticPaths() {
  // Initialize CMS helper
  initCmsHelper(cmsData as CMSCache);

  const cmsWorkData = getModuleDataBySlug("work");

  // Transform CMS data to match expected format
  const workPosts = cmsWorkData.map((item) => {
    const data = item.data as Record<string, any>;
    const generatedSlug = data.slug || slugify(data.title || item.id);

    return {
      id: item.id,
      slug: generatedSlug,
      data: {
        title: data.title || "Untitled",
        slug: generatedSlug,
        publishedDate: data.published_date || null,
        description: data.description || data.excerpt || "",
        category: data.category || "",
        heroImage: data.featured_image || "",
        url: data.project_url || "",
        logo: data.logo || "",
        metaTitle: data.title || "Untitled",
        metaDescription: data.description || "",
      },
      rawData: data,
    };
  });

  const allCategories = getAllCategories(workPosts);
  const paths: Array<{
    params: { slug: string };
    props: {
      isCategory: boolean;
      category: string | null;
      posts: typeof workPosts | null;
      item: any;
    };
  }> = [];

  // Generate category pages
  allCategories.forEach((category) => {
    const filteredPosts = workPosts.filter(
      (post) => post.data.category === category
    );
    paths.push({
      params: { slug: category.toLowerCase() },
      props: {
        isCategory: true,
        category,
        posts: filteredPosts,
        item: null,
      },
    });
  });

  // Generate individual work item pages
  cmsWorkData.forEach((item) => {
    const data = item.data as Record<string, any>;
    const slug = data.slug || slugify(data.title || item.id);

    // Only add if slug doesn't conflict with a category
    if (
      !allCategories.some((cat) => cat.toLowerCase() === slug.toLowerCase())
    ) {
      paths.push({
        params: { slug },
        props: {
          isCategory: false,
          category: null,
          posts: null,
          item,
        },
      });
    }
  });

  return paths;
}

const { isCategory, item, category, posts } = Astro.props;

// Get the slug from the URL params to ensure consistency
const currentSlug = Astro.params.slug;

// Prepare data for individual posts
const data = isCategory ? null : (item.data as Record<string, any>);
const highlightedContent = isCategory
  ? null
  : await highlightCodeBlocks(data?.content || "");

if (!isCategory && !item) {
  return Astro.redirect("/404");
}
---

{
  isCategory ? (
    <WorkLayout currentCategory={category} posts={posts || []} />
  ) : data ? (
    <Layout
      title={data.title || "Untitled"}
      description={data.description || data.excerpt || ""}
    >
      <div class="relative">
        <div class="container relative pt-6 flex flex-col">
          {data.logo ? (
            <div class="bg-white aspect-square size-44 mb-6 grid place-items-center">
              <img
                src={data.logo}
                alt={`${data.title} logo`}
                class="size-44 object-contain"
                transition:name={`work-image-${currentSlug}`}
              />
            </div>
          ) : data.featured_image ? (
            <div class="mb-6 max-w-3xl">
              <img
                src={data.featured_image}
                alt={`${data.title} hero image`}
                class="w-full object-cover"
                transition:name={`work-image-${currentSlug}`}
              />
            </div>
          ) : null}

          <div>
            {data.published_date !== null && (
              <span class="text-foreground-muted">
                Published on {data.published_date}
              </span>
            )}

            {data.project_url && (
              <div class="pt-6">
                <a
                  href={data.project_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center gap-2 hover:text-primary w-full md:max-w-[25%] bg-black hover:bg-neutral-950 border border-lines py-2.5 px-4 transition-colors"
                >
                  <span class="">View Live Website</span>
                  <ExternalLink class="size-5" />
                </a>
              </div>
            )}
          </div>
        </div>
      </div>

      <div class="container pt-6 pb-12 md:pb-20">
        <div class="content-sections" set:html={highlightedContent} />
      </div>
    </Layout>
  ) : null
}
