---
import { getCollection, getEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import type { CollectionEntry } from "astro:content";
import ExternalLink from "../../components/icons/ExternalLink.astro";
import { render } from "astro:content";

export async function getStaticPaths() {
  const workProjects = await getCollection("work");
  return workProjects
    .filter(
      (project: CollectionEntry<"work">) =>
        project.data.slug && project.data.slug !== "work"
    ) // Filter out empty slugs and avoid conflict with /work
    .map((project: CollectionEntry<"work">) => ({
      params: { slug: project.data.slug },
      props: { project },
    }));
}

interface Props {
  project: CollectionEntry<"work">;
}

const { project }: Props = Astro.props;
const { Content } = await render(project);
---

<Layout
  title={project.data.metaTitle || project.data.title}
  description={project.data.metaDescription || project.data.description}
>
  <!-- Hero Section with floating elements -->
  <div class="relative">
    <div class="container relative pt-6 flex flex-col">
      {
        project.data.logo ? (
          <div class="bg-white aspect-square size-44 mb-6 grid place-items-center">
            <img
              src={project.data.logo}
              alt={`${project.data.title} logo`}
              class="size-44 object-contain group-hover:scale-110 transition-transform duration-300"
            />
          </div>
        ) : project.data.heroImage ? (
          <div class="mb-6 max-w-3xl">
            <img
              src={project.data.heroImage}
              alt={`${project.data.title} hero image`}
              class="w-full object-cover"
            />
          </div>
        ) : null
      }
      <div>
        <h1 class="text-3xl! md:text-5xl! font-bold mb-4 bg-linear-to-br">
          {project.data.title}
        </h1>
        <p class="text-lg text-neutral-300 leading-relaxed max-w-prose">
          {project.data.description}
        </p>

        {
          project.data.url && (
            <div class="pt-6">
              <a
                href={project.data.url}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 hover:text-primary w-full md:max-w-[25%] bg-black hover:bg-neutral-950 border border-lines py-2.5 px-4 transition-colors"
              >
                <span class="">View Live Website</span>
                <ExternalLink class="size-5" />
              </a>
            </div>
          )
        }
      </div>
    </div>
  </div>

  <!-- Main Content with dynamic sections -->
  <div class="container content-sections pb-20 grid-cols-4 md:grid-cols-8">
    <Content />

    <!-- Blog footer here -->
  </div>
</Layout>

<style>
  /* Smooth scroll behavior */
  html {
    scroll-behavior: smooth;
  }

  /* Enhanced typography with better visual rhythm */
  .content-sections :global(h2) {
    color: var(--color-primary);
    font-size: 2.5rem;
    line-height: 1.2;
    margin-top: 4rem;
    padding-bottom: 1rem;
    font-weight: 700;
    position: relative;
    scroll-margin-top: 100px;
  }
  .content-sections :global(h3) {
    color: var(--color-foreground);
    font-size: 1.75rem;
    line-height: 1.3;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    font-weight: 600;
    position: relative;
    padding-left: 1.5rem;
  }

  .content-sections :global(h3::before) {
    content: "";
    position: absolute;
    left: 0;
    top: 0.5rem;
    width: 4px;
    height: 1.5rem;
    background: var(--color-primary);
    border-radius: 2px;
  }

  .content-sections :global(p) {
    color: var(--color-foreground-muted);
    line-height: 1.7;
    margin-bottom: 1.5rem;
    text-align: justify;
    max-width: 680px;
  }

  .content-sections :global(p:first-of-type) {
    color: var(--color-foreground);
    font-weight: 500;
  }

  /* Enhanced lists with better visual hierarchy */
  .content-sections :global(ul),
  .content-sections :global(ol) {
    margin: 2rem 0;
    padding-left: 0;
    list-style: none;
  }

  .content-sections :global(li) {
    color: var(--color-foreground-muted);
    font-size: 1.125rem;
    line-height: 1.7;
    margin-bottom: 1rem;
    position: relative;
    padding-left: 2rem;
  }

  .content-sections :global(li strong) {
    color: var(--color-primary);
    font-weight: 600;
    display: block;
    margin-bottom: 0.25rem;
  }

  /* Dynamic image containers */
  .content-sections :global(img) {
    width: 100%;
    height: auto;
    transition: all 0.3s ease;
    border: 1px solid var(--color-lines);
  }

  .content-sections :global(img.full-width) {
    width: 75%;
  }

  /* Enhanced blockquotes */
  .content-sections :global(blockquote) {
    background: rgba(255, 255, 255, 0.03);
    border-left: 4px solid var(--color-primary);
    border-radius: 0 8px 8px 0;
    padding: 2rem;
    margin: 3rem 0;
    font-style: italic;
    font-size: 1.25rem;
    line-height: 1.6;
    position: relative;
  }

  .content-sections :global(blockquote::before) {
    content: '"';
    position: absolute;
    top: -0.5rem;
    left: 1rem;
    font-size: 4rem;
    color: var(--color-primary);
    opacity: 0.3;
  }

  /* Code blocks with enhanced styling */
  .content-sections :global(pre) {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--color-lines);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    overflow-x: auto;
    position: relative;
    backdrop-filter: blur(10px);
  }

  .content-sections :global(pre::before) {
    content: "";
    position: absolute;
    top: 1rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background: #ff5f56;
    border-radius: 50%;
    box-shadow:
      20px 0 #ffbd2e,
      40px 0 #27ca3f;
  }

  .content-sections :global(code) {
    background: rgba(255, 255, 255, 0.1);
    color: var(--color-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.9em;
    font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
  }

  .content-sections :global(pre code) {
    background: none;
    padding: 0;
    color: var(--color-foreground);
  }

  /* Navigation link highlighting */
  .nav-link.active {
    color: var(--color-primary);
    background: rgba(255, 255, 255, 0.1);
    font-weight: 600;
  }

  /* Smooth animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .content-sections :global(> *) {
    animation: fadeInUp 0.6s ease-out forwards;
  }

  .content-sections :global(> *:nth-child(2)) {
    animation-delay: 0.1s;
  }
  .content-sections :global(> *:nth-child(3)) {
    animation-delay: 0.2s;
  }
  .content-sections :global(> *:nth-child(4)) {
    animation-delay: 0.3s;
  }
  .content-sections :global(> *:nth-child(5)) {
    animation-delay: 0.4s;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .content-sections::before {
      display: none;
    }

    .content-sections :global(h2::before) {
      display: none;
    }

    .content-sections :global(h3) {
      padding-left: 0;
    }

    .content-sections :global(h3::before) {
      display: none;
    }

    .content-sections :global(img.full-width) {
      width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
  }

  /* Intersection observer for navigation highlighting */
  .nav-link {
    position: relative;
  }

  .nav-link::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 0;
    height: 2px;
    background: var(--color-primary);
    transition: width 0.3s ease;
  }

  .nav-link:hover::after,
  .nav-link.active::after {
    width: 100%;
  }
</style>

<script>
  // Add smooth scrolling navigation highlighting
  document.addEventListener("DOMContentLoaded", function () {
    const navLinks = document.querySelectorAll(".nav-link");
    const sections = document.querySelectorAll("h2[id]");

    // Create intersection observer
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Remove active class from all links
            navLinks.forEach((link) => link.classList.remove("active"));

            // Add active class to corresponding link
            const correspondingLink = document.querySelector(
              `[data-target="${entry.target.id}"]`
            );
            if (correspondingLink) {
              correspondingLink.classList.add("active");
            }
          }
        });
      },
      {
        threshold: 0.3,
        rootMargin: "-100px 0px -60% 0px",
      }
    );

    // Observe all h2 sections
    sections.forEach((section) => observer.observe(section));

    // Add smooth scroll behavior to nav links
    navLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = link.getAttribute("data-target");

        if (targetId) {
          const targetSection = document.getElementById(targetId);

          if (targetSection) {
            targetSection.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        }
      });
    });
  });
</script>
