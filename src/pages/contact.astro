---
import SpinnerIcon from "../components/icons/SpinnerIcon.astro";
import Layout from "../layouts/Layout.astro";
import { SOCIAL_LINKS } from "../lib/data";
---

<Layout>
  <div class="container">
    <h1>contact me</h1>
    <p>
      feel free to reach out to me via email at
      <a
        href="mailto:aaron@ayezeewebdesigns.com"
        class="text-primary hover:underline">aaron@ayezeewebdesigns.com</a
      >
      or use the form below:
    </p>

    <form id="contact-form" class="w-full grid grid-cols-4 md:grid-cols-8 mt-8">
      <div class="col-span-4">
        <label for="name" class="block mt-4 mb-2">name:</label>
        <input
          type="text"
          id="name"
          name="name"
          class="w-full border border-lines bg-neutral-950 py-2 px-3"
          required
        />

        <label for="email" class="block mt-4 mb-2">email:</label>
        <input
          type="email"
          id="email"
          name="email"
          class="w-full border border-lines bg-neutral-950 py-2 px-3"
          required
        />

        <label for="message" class="block mt-4 mb-2">message:</label>
        <textarea
          id="message"
          name="message"
          rows="5"
          class="w-full border border-lines bg-neutral-950 py-2 px-3"
          required></textarea>

        <button
          type="submit"
          id="submit-button"
          class="mt-4 bg-neutral-950 hover:bg-neutral-900 border border-lines text-white py-2.5 px-4 w-1/2 transition-all flex items-center justify-center h-[46px] disabled:opacity-75 disabled:cursor-not-allowed"
        >
          <span id="button-text" class="flex items-center justify-center h-6"
            >send message</span
          >
          <span
            id="button-spinner"
            class="hidden items-center justify-center h-6"
          >
            <SpinnerIcon />
          </span>
        </button>

        <div id="form-message" class="hidden mt-4 p-3 border rounded text-sm">
        </div>
      </div>
    </form>

    <p class="mt-12">
      you can also find me on social media:
      <ul class="flex gap-6 mt-2">
        {
          Object.values(SOCIAL_LINKS).map((link) => (
            <li>
              <a href={link.url} class="text-primary hover:underline">
                {link.name}
              </a>
            </li>
          ))
        }
      </ul>
    </p>

    <!-- mailTo Button -->
    <div class="mt-6">
      <a
        href="mailto:aaron@ayezeewebdesigns.com"
        class="bg-neutral-950 hover:bg-neutral-900 border border-lines text-white py-2.5 px-16 transition-all w-fit flex items-center justify-center h-[46px]"
      >
        send me an email
      </a>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const submitButton = document.getElementById(
      "submit-button"
    ) as HTMLButtonElement;
    const buttonText = document.getElementById(
      "button-text"
    ) as HTMLSpanElement;
    const buttonSpinner = document.getElementById(
      "button-spinner"
    ) as HTMLSpanElement;
    const formMessage = document.getElementById(
      "form-message"
    ) as HTMLDivElement;

    // Get environment variables
    const API_CONFIG = {
      baseUrl: import.meta.env.PUBLIC_CMS_DOMAIN || "localhost:3000",
      projectSlug: import.meta.env.PUBLIC_PROJECT_SLUG || "portfolio",
      instanceKey:
        import.meta.env.PUBLIC_INSTANCE_KEY || "contact_form-1761612119807",
      apiKey: import.meta.env.PUBLIC_AYEZEE_API_KEY,
    };

    function showMessage(message: string, isSuccess: boolean = true) {
      formMessage.textContent = message;
      formMessage.classList.remove("hidden");

      if (isSuccess) {
        formMessage.classList.remove(
          "border-red-500",
          "bg-red-950",
          "text-red-200"
        );
        formMessage.classList.add(
          "border-green-500",
          "bg-green-950",
          "text-green-200"
        );
      } else {
        formMessage.classList.remove(
          "border-green-500",
          "bg-green-950",
          "text-green-200"
        );
        formMessage.classList.add(
          "border-red-500",
          "bg-red-950",
          "text-red-200"
        );
      }
    }

    function hideMessage() {
      formMessage.classList.add("hidden");
    }

    function setButtonLoading(isLoading: boolean) {
      submitButton.disabled = isLoading;

      if (isLoading) {
        buttonText.classList.add("hidden");
        buttonSpinner.classList.remove("hidden");
        buttonSpinner.classList.add("flex");
      } else {
        buttonText.classList.remove("hidden");
        buttonSpinner.classList.add("hidden");
        buttonSpinner.classList.remove("flex");
      }
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      // Hide any previous messages
      hideMessage();

      // Show loading state
      setButtonLoading(true);

      try {
        // Get form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Basic validation
        if (!data.name || !data.email || !data.message) {
          showMessage("Please fill in all required fields.", false);
          return;
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(data.email as string)) {
          showMessage("Please enter a valid email address.", false);
          return;
        }

        // Check if API key is configured
        if (!API_CONFIG.apiKey || API_CONFIG.apiKey === "your-api-key-here") {
          showMessage(
            "Contact form is not properly configured. Please use the email link above.",
            false
          );
          return;
        }

        // Submit to your CMS API
        let apiUrl;
        if (
          API_CONFIG.baseUrl.startsWith("http://") ||
          API_CONFIG.baseUrl.startsWith("https://")
        ) {
          apiUrl = `${API_CONFIG.baseUrl}/api/v1/projects/${API_CONFIG.projectSlug}/submit/${API_CONFIG.instanceKey}`;
        } else {
          const protocol = API_CONFIG.baseUrl.includes("localhost")
            ? "http://"
            : "https://";
          apiUrl = `${protocol}${API_CONFIG.baseUrl}/api/v1/projects/${API_CONFIG.projectSlug}/submit/${API_CONFIG.instanceKey}`;
        }

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${API_CONFIG.apiKey}`,
          },
          body: JSON.stringify({
            name: data.name,
            email: data.email,
            message: data.message,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          showMessage(
            "Message sent successfully! I'll get back to you soon. Thank you!",
            true
          );
          form.reset();
        } else {
          // Handle specific error cases
          let errorMessage = "Failed to send message. Please try again.";

          if (result.error) {
            if (result.code === "VALIDATION_ERROR" && result.validationErrors) {
              errorMessage = `Validation error: ${result.validationErrors.join(", ")}`;
            } else if (result.code === "API_KEY_MISSING") {
              errorMessage =
                "Contact form configuration error. Please use the email link above.";
            } else if (result.code === "INVALID_CREDENTIALS") {
              errorMessage =
                "Contact form configuration error. Please use the email link above.";
            } else {
              errorMessage = result.error;
            }
          } else if (result.message) {
            errorMessage = result.message;
          } else if (result.validationErrors) {
            errorMessage = `Validation error: ${Array.isArray(result.validationErrors) ? result.validationErrors.join(", ") : result.validationErrors}`;
          }

          showMessage(errorMessage, false);
        }
      } catch (error) {
        console.error("Contact form error:", error);
        showMessage(
          "Network error. Please check your connection and try again, or use the email link above.",
          false
        );
      } finally {
        setButtonLoading(false);
      }
    });
  });
</script>
