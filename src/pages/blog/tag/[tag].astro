---
import BlogLayout from "../../../components/BlogLayout.astro";
import { getAllTags, safeDate } from "../../../lib/utils";
import { getModuleDataBySlug } from "../../../lib/ayezee-cms-helper";

export async function getStaticPaths() {
  const cmsBlogData = getModuleDataBySlug("blog");

  // Transform CMS data to match expected format
  const blogPosts = cmsBlogData.map((item) => {
    const data = item.data as Record<string, any>;
    const pubDate = safeDate(data.pubDate || item.createdAt);
    const updatedDate = item.updatedAt ? safeDate(item.updatedAt) : undefined;

    return {
      id: item.id,
      slug: data.slug || item.id,
      body: data.content || "",
      data: {
        title: data.title || "Untitled",
        slug: data.slug || item.id, // Add slug to data object for BlogGrid component
        description: data.excerpt || data.description || "",
        pubDate,
        updatedDate,
        heroImage: data.featured_image || data.heroImage,
        tags: data.tags || [],
      },
    };
  });

  const allTags = getAllTags(blogPosts);

  return allTags.map((tag) => ({
    params: { tag },
    props: { blogPosts, allTags, selectedTag: tag },
  }));
}

const { blogPosts, allTags, selectedTag } = Astro.props;
const filteredPosts = blogPosts.filter((post: any) =>
  post.data?.tags?.includes(selectedTag)
);
---

<BlogLayout allTags={allTags} currentTag={selectedTag} posts={filteredPosts} />
