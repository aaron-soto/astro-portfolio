---
import BlogPost from "../../layouts/BlogPost.astro";
import { getModuleDataBySlug } from "../../lib/ayezee-cms-helper";
import { highlightCodeBlocks } from "../../lib/highlight-code";
import { safeDate } from "../../lib/utils";

export async function getStaticPaths() {
  const cmsBlogData = getModuleDataBySlug("blog");

  return cmsBlogData.map((item) => {
    const data = item.data as Record<string, any>;
    return {
      params: { slug: data.slug || item.id },
      props: { item },
    };
  });
}

const { item } = Astro.props;
const data = item.data as Record<string, any>;

if (!item) {
  return Astro.redirect("/404");
}

// Apply syntax highlighting to code blocks
const highlightedContent = await highlightCodeBlocks(data.content || "");

// Get related posts (exclude current post and get 2 random posts)
const allBlogPosts = getModuleDataBySlug("blog");
const relatedPosts = allBlogPosts
  .filter((post) => post.id !== item.id)
  .sort(() => Math.random() - 0.5)
  .slice(0, 2)
  .map((post) => {
    const postData = post.data as Record<string, any>;
    return {
      id: post.id,
      slug: postData.slug || post.id,
      data: {
        title: postData.title || "Untitled",
        description: postData.excerpt || postData.description || "",
        pubDate: safeDate(postData.pubDate || post.createdAt),
        heroImage: postData.featured_image || postData.heroImage,
      },
    };
  });
---

<BlogPost
  title={data.title || "Untitled"}
  description={data.excerpt || data.description || ""}
  pubDate={safeDate(data.pubDate || item.createdAt)}
  updatedDate={item.updatedAt ? safeDate(item.updatedAt) : undefined}
  heroImage={data.featured_image || data.heroImage}
  relatedPosts={relatedPosts}
>
  <div set:html={highlightedContent} />
</BlogPost>
