---
import Layout from "../../layouts/Layout.astro";
import BlogLayout from "../../components/BlogLayout.astro";
import Arrow from "../../components/icons/Arrow.astro";
import {
  initCmsHelper,
  getModuleDataBySlug,
  type CMSCache,
} from "ayezee-astro-cms";
import cmsData from "../../data/cms-cache.json";
import { highlightCodeBlocks } from "../../lib/highlight-code";
import { getAllTags, safeDate, slugify } from "../../lib/utils";
import "../../styles/content-sections.css";

export async function getStaticPaths() {
  // Initialize CMS helper
  initCmsHelper(cmsData as CMSCache);

  const cmsBlogData = getModuleDataBySlug("blog");

  // Transform CMS data to match expected format
  const blogPosts = cmsBlogData.map((item) => {
    const data = item.data as Record<string, any>;
    const pubDate = safeDate(data.pubDate || item.createdAt);
    const updatedDate = item.updatedAt ? safeDate(item.updatedAt) : undefined;
    const generatedSlug = data.slug || slugify(data.title || item.id);

    return {
      id: item.id,
      slug: generatedSlug,
      body: data.content || "",
      data: {
        title: data.title || "Untitled",
        slug: generatedSlug,
        description: data.excerpt || data.description || "",
        pubDate,
        updatedDate,
        heroImage: data.featured_image || data.heroImage,
        heroAlt: data.heroAlt || `${data.title} hero image`,
        tags: data.category ? [data.category] : [],
      },
      rawData: data,
    };
  });

  const allTags = getAllTags(blogPosts);
  const paths: any[] = [];

  // Generate tag pages
  allTags.forEach((tag) => {
    const filteredPosts = blogPosts.filter((post) =>
      post.data.tags.includes(tag)
    );
    // Create URL-safe slug by replacing slashes and special characters
    const tagSlug = tag.toLowerCase().replace(/\//g, "-").replace(/\s+/g, "-");

    paths.push({
      params: { slug: tagSlug },
      props: {
        type: "tag",
        tag,
        posts: filteredPosts,
        allTags,
        item: null,
      },
    });
  });

  // Generate individual blog post pages
  cmsBlogData.forEach((item) => {
    const data = item.data as Record<string, any>;
    const slug = data.slug || slugify(data.title || item.id);

    // Only add if slug doesn't conflict with a tag
    const tagSlugs = allTags.map((tag) =>
      tag.toLowerCase().replace(/\//g, "-").replace(/\s+/g, "-")
    );

    if (!tagSlugs.includes(slug.toLowerCase())) {
      paths.push({
        params: { slug },
        props: {
          type: "post",
          tag: null,
          posts: null,
          allTags,
          item,
        },
      });
    }
  });

  return paths;
}

const { type, item, tag, posts, allTags } = Astro.props;

// Get the slug from the URL params to ensure consistency
const currentSlug = Astro.params.slug;

// Prepare data for individual posts
const data = type === "post" ? (item.data as Record<string, any>) : null;
const highlightedContent =
  type === "post" && data
    ? await highlightCodeBlocks(data.content || "")
    : null;

if (type === "post" && !item) {
  return Astro.redirect("/404");
}
---

{
  type === "tag" ? (
    <BlogLayout
      currentTag={tag}
      posts={posts}
      allTags={allTags}
      pageTitle={`Blog - ${tag}`}
      description={`All blog posts tagged with ${tag}`}
    />
  ) : data ? (
    <Layout
      title={data.title || "Untitled"}
      description={data.description || data.excerpt || ""}
    >
      <div class="relative">
        <div class="container relative flex flex-col">
          <a
            href="/blog"
            class="inline-flex items-center gap-4 text-foreground-muted hover:text-primary transition-colors mb-6 group w-fit"
          >
            <Arrow class="inline rotate-270 group-hover:rotate-225 transition-all" />
            <span>Back to Blog</span>
          </a>

          {data.featured_image && (
            <div class="mb-6 max-w-3xl">
              <img
                src={data.featured_image}
                alt={data.heroAlt || `${data.title} hero image`}
                class="w-full object-cover"
                transition:name={`blog-image-${currentSlug}`}
              />
            </div>
          )}

          <div>
            <h1 class="text-3xl! md:text-5xl! font-bold mb-4">{data.title}</h1>

            {data.description && (
              <p class="text-lg text-neutral-300 leading-relaxed max-w-prose mb-4">
                {data.description}
              </p>
            )}

            <div class="flex items-center gap-4 text-sm text-neutral-400 mb-6">
              {data.pubDate && (
                <time datetime={new Date(data.pubDate).toISOString()}>
                  {new Date(data.pubDate).toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })}
                </time>
              )}

              {data.category && (
                <span class="px-3 py-1 bg-primary/20 text-primary rounded-full">
                  #{data.category}
                </span>
              )}
            </div>
          </div>
        </div>
      </div>

      <div class="container py-12 md:py-20">
        <div class="content-sections" set:html={highlightedContent} />
      </div>
    </Layout>
  ) : null
}
