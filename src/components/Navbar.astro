---
import AaronLogo from "./AaronLogo.astro";

// Get the current pathname for active link styling
const currentPath = Astro.url.pathname;

// Helper function to determine if a link is active
function isActive(href: string): boolean {
  if (href === "/" && currentPath === "/") return true;
  if (href !== "/" && currentPath.startsWith(href)) return true;
  return false;
}

// Navigation items
const navItems = [
  { href: "/", label: "home" },
  { href: "/about", label: "about" },
  { href: "/blog", label: "blog" },
  { href: "/work", label: "work" },
  { href: "/resume", label: "resume" },
];
---

<div
  class="sticky top-0 bg-linear-to-b from-black via-black to-transparent z-20 via-20% from-60% pb-6 md:pb-3"
  transition:name="navbar"
>
  <div class="container py-6 md:py-4">
    <div class="flex flex-row justify-between items-center pb-4 relative z-30">
      <AaronLogo transition:name="main-logo" />

      <!-- Mobile Menu Toggle -->
      <div class="md:hidden z-30 relative scale-80">
        <input type="checkbox" id="mobile-menu-checkbox" class="hidden" />
        <label for="mobile-menu-checkbox" class="toggle">
          <div class="bar bar--top"></div>
          <div class="bar bar--middle"></div>
          <div class="bar bar--bottom"></div>
        </label>
      </div>

      <!-- Desktop Navigation -->
      <nav class="items-center hidden md:flex">
        <ul class="flex gap-4">
          {
            navItems.map((item) => (
              <li>
                <a
                  href={item.href}
                  class={`transition-colors hover:underline ${
                    isActive(item.href)
                      ? "text-foreground font-medium"
                      : "text-foreground-muted"
                  }`}
                >
                  {item.label}
                </a>
              </li>
            ))
          }
        </ul>

        <a
          href="/contact"
          class={`py-2 px-6 ml-2 hover:underline transition-all ${
            isActive("/contact") ? "text-primary font-medium" : "text-primary"
          }`}
        >
          get in touch
        </a>
      </nav>
    </div>
  </div>

  <!-- Mobile Menu Overlay -->
  <div
    id="mobile-menu"
    class="fixed inset-0 bg-black bg-opacity-95 z-20 md:hidden opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out max-h-screen overflow-y-auto"
  >
    <nav
      class="flex flex-col items-center justify-center w-full h-full px-6 pt-44 pb-12"
    >
      <ul id="mobile-menu-links" class="w-full flex flex-col gap-8">
        {
          navItems.map((item, index) => (
            <li
              class="transform translate-y-8 opacity-0 transition-all duration-150 ease-out"
              style={`transition-delay: ${100}ms`}
            >
              <a
                href={item.href}
                class={`text-3xl transition-colors hover:text-primary ${
                  isActive(item.href)
                    ? "text-primary font-medium"
                    : "text-foreground-muted"
                }`}
              >
                {item.label}
              </a>
            </li>
          ))
        }
      </ul>

      <div
        id="mobile-menu-button"
        class="transform translate-y-8 opacity-0 transition-all duration-300 ease-out mt-auto w-full"
        style={`transition-delay: ${100 + navItems.length}ms`}
      >
        <a
          href="/contact"
          class={`text-2xl transition-colors border text-center inline-block w-full border-lines px-20 py-3 hover:bg-primary hover:text-white`}
        >
          get in touch
        </a>
      </div>
    </nav>
  </div>
</div>

<script>
  // Global variable to track menu state and prevent multiple initializations
  declare global {
    interface Window {
      navbarInitialized?: boolean;
      mobileMenuState?: {
        isOpen: boolean;
        cleanup: () => void;
      };
    }
  }

  function initializeNavbar() {
    // Cleanup any existing initialization
    if (window.mobileMenuState) {
      window.mobileMenuState.cleanup();
    }

    const mobileMenuCheckbox = document.getElementById(
      "mobile-menu-checkbox"
    ) as HTMLInputElement;
    const mobileMenu = document.getElementById("mobile-menu");
    const mobileMenuLinks = document.querySelectorAll("#mobile-menu-links li");
    const mobileMenuButton = document.getElementById("mobile-menu-button");

    if (!mobileMenuCheckbox || !mobileMenu) {
      return; // Exit if elements don't exist
    }

    function toggleMenu() {
      if (!mobileMenu) return;

      const isMenuOpen = mobileMenuCheckbox.checked;

      if (isMenuOpen) {
        // Open menu
        mobileMenu.classList.remove("opacity-0", "pointer-events-none");
        mobileMenu.classList.add("opacity-100");

        // Animate links in with staggered delay
        mobileMenuLinks.forEach((link, index) => {
          setTimeout(
            () => {
              link.classList.remove("translate-y-8", "opacity-0");
              link.classList.add("translate-y-0", "opacity-100");
            },
            150 + index * 100
          );
        });

        // Animate button
        if (mobileMenuButton) {
          setTimeout(
            () => {
              mobileMenuButton.classList.remove("translate-y-8", "opacity-0");
              mobileMenuButton.classList.add("translate-y-0", "opacity-100");
            },
            150 + mobileMenuLinks.length * 100
          );
        }

        // Prevent body scroll
        document.body.style.overflow = "hidden";
        document.body.style.position = "fixed";
        document.body.style.width = "100%";
      } else {
        // Close menu
        mobileMenu.classList.add("opacity-0", "pointer-events-none");
        mobileMenu.classList.remove("opacity-100");

        // Reset links
        mobileMenuLinks.forEach((link) => {
          link.classList.add("translate-y-8", "opacity-0");
          link.classList.remove("translate-y-0", "opacity-100");
        });

        // Reset button
        if (mobileMenuButton) {
          mobileMenuButton.classList.add("translate-y-8", "opacity-0");
          mobileMenuButton.classList.remove("translate-y-0", "opacity-100");
        }

        // Restore body scroll
        document.body.style.overflow = "";
        document.body.style.position = "";
        document.body.style.width = "";
      }
    }

    function handleEscape(e: KeyboardEvent) {
      if (e.key === "Escape" && mobileMenuCheckbox.checked) {
        mobileMenuCheckbox.checked = false;
        toggleMenu();
      }
    }

    function handleLinkClick() {
      if (mobileMenuCheckbox.checked) {
        mobileMenuCheckbox.checked = false;
        toggleMenu();
      }
    }

    // Add event listeners
    mobileMenuCheckbox.addEventListener("change", toggleMenu);

    // Close menu when clicking on a link
    mobileMenuLinks.forEach((link) => {
      link.addEventListener("click", handleLinkClick);
    });

    // Close menu when clicking on button
    if (mobileMenuButton) {
      mobileMenuButton.addEventListener("click", handleLinkClick);
    }

    // Close menu when pressing escape
    document.addEventListener("keydown", handleEscape);

    // Store state and cleanup function globally
    window.mobileMenuState = {
      isOpen: mobileMenuCheckbox.checked,
      cleanup: () => {
        mobileMenuCheckbox.removeEventListener("change", toggleMenu);
        mobileMenuLinks.forEach((link) => {
          link.removeEventListener("click", handleLinkClick);
        });
        if (mobileMenuButton) {
          mobileMenuButton.removeEventListener("click", handleLinkClick);
        }
        document.removeEventListener("keydown", handleEscape);

        // Reset menu state
        if (mobileMenuCheckbox.checked) {
          mobileMenuCheckbox.checked = false;
          toggleMenu();
        }

        // Restore body scroll just in case
        document.body.style.overflow = "";
        document.body.style.position = "";
        document.body.style.width = "";
      },
    };
  }

  // Initialize on both DOMContentLoaded and astro:page-load (for client-side navigation)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeNavbar);
  } else {
    initializeNavbar();
  }

  // Re-initialize when navigating between pages with Astro's client-side navigation
  document.addEventListener("astro:page-load", initializeNavbar);

  // Cleanup when leaving the page
  document.addEventListener("astro:before-preparation", () => {
    if (window.mobileMenuState) {
      window.mobileMenuState.cleanup();
    }
  });
</script>

<style>
  #mobile-menu-checkbox {
    display: none;
  }

  .toggle {
    position: relative;
    width: 36px;
    cursor: pointer;
    margin: auto;
    display: block;
    height: calc(4px * 3 * 2);
  }

  .bar {
    position: absolute;
    left: 0;
    right: 0;
    height: 3px;
    border-radius: calc(4px / 2);
    background: var(--color-primary);
    color: inherit;
    opacity: 1;
    transition: none 0.35s cubic-bezier(0.5, -0.35, 0.35, 1.5) 0s;
  }

  /***** Spin Animation *****/

  .bar--top {
    bottom: calc(50% + 8px + 4px / 2);
    transition-property: bottom, transform;
    transition-delay: calc(0s + 0.35s), 0s;
  }

  .bar--middle {
    top: calc(50% - 4px / 2);
    transition-property: opacity;
    transition-delay: calc(0s + 0.35s);
  }

  .bar--bottom {
    top: calc(50% + 8px + 4px / 2);
    transition-property: top, transform;
    transition-delay: calc(0s + 0.35s), 0s;
  }

  #mobile-menu-checkbox:checked + .toggle .bar--top {
    bottom: calc(50% - 4px / 2);
    transform: rotate(135deg);
    transition-delay: 0s, calc(0s + 0.35s);
  }

  #mobile-menu-checkbox:checked + .toggle .bar--middle {
    opacity: 0;
    transition-duration: 0s;
    transition-delay: calc(0s + 0.35s);
  }

  #mobile-menu-checkbox:checked + .toggle .bar--bottom {
    top: calc(50% - 4px / 2);
    transform: rotate(225deg);
    transition-delay: 0s, calc(0s + 0.35s);
  }
</style>
