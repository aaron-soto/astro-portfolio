---
import Arrow from "../icons/Arrow.astro";
import {
  initCmsHelper,
  getModuleDataBySlug,
  type CMSCache,
} from "ayezee-astro-cms";
import cmsData from "../../data/cms-cache.json";
import { slugify } from "../../lib/utils";

// Initialize CMS helper
initCmsHelper(cmsData as CMSCache);

// Get work projects from CMS
const cmsWorkData = getModuleDataBySlug("work");

// Transform CMS data to match expected format
const workProjects = cmsWorkData.map((item) => {
  const data = item.data as Record<string, any>;
  const generatedSlug = data.slug || slugify(data.title || item.id);

  return {
    id: item.id,
    slug: generatedSlug,
    data: {
      title: data.title || "Untitled",
      slug: generatedSlug,
      description: data.description || data.excerpt || "",
      category: data.category || "",
      heroImage: data.featured_image || "",
      url: data.project_url || "",
      logo: data.logo || "",
      tags: data.tags || [],
    },
  };
});

// Get featured project (first one) and 3 recent projects
const featuredProject = workProjects[0];
const recentProjects = workProjects.slice(1, 4);
---

<div
  class="relative bg-[linear-gradient(to_bottom,transparent_0%,black_10%,black_90%,transparent_100%)] py-20"
>
  <div class="container">
    <div class="flex items-center gap-4 mt-4 mb-12">
      <p class="text-white">
        <span class="text-primary">//</span> featured work
      </p>
      <div class="h-px bg-lines flex-1"></div>
    </div>

    <!-- Featured Project -->
    {
      featuredProject && (
        <div class="mb-16">
          <a
            href={`/work/${featuredProject.data.slug}`}
            class="group grid grid-cols-1 md:grid-cols-2 gap-8 items-center md:border border-lines hover:border-primary transition-colors"
          >
            <div class="relative aspect-video overflow-hidden bg-neutral-900">
              {featuredProject.data.logo ? (
                <div class="grid h-full place-items-center bg-white p-12">
                  <img
                    src={featuredProject.data.logo}
                    alt={`${featuredProject.data.title} logo`}
                    class="max-h-full max-w-full object-contain transition-transform duration-300 group-hover:scale-105"
                    transition:name={`work-image-${featuredProject.data.slug}`}
                  />
                </div>
              ) : featuredProject.data.heroImage ? (
                <img
                  src={featuredProject.data.heroImage}
                  alt={`${featuredProject.data.title} hero image`}
                  class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                  transition:name={`work-image-${featuredProject.data.slug}`}
                />
              ) : (
                <div class="grid h-full place-items-center bg-gradient-to-br from-primary/20 to-primary/5">
                  <span class="text-primary/30 text-6xl font-bold">
                    {featuredProject.data.title.charAt(0)}
                  </span>
                </div>
              )}
            </div>

            <div class="flex flex-col">
              <span class="text-foreground-muted text-sm mb-2">
                {featuredProject.data.category}
              </span>
              <h3 class="text-3xl font-bold mb-4 group-hover:text-primary transition-colors">
                {featuredProject.data.title}
              </h3>
              <p class="text-foreground-muted mb-6">
                {featuredProject.data.description}
              </p>

              <div class="flex flex-wrap gap-2 mb-6">
                {featuredProject.data.category && (
                  <span class="px-3 py-1 bg-lines text-xs text-foreground-muted">
                    {featuredProject.data.category}
                  </span>
                )}
              </div>

              <div class="flex gap-3 mt-auto">
                {featuredProject.data.url && (
                  <a
                    href={featuredProject.data.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="px-6 py-2.5 bg-black hover:border-primary hover:text-primary transition-all border border-lines text-center text-sm"
                    onclick="event.stopPropagation()"
                  >
                    View Live
                  </a>
                )}
                <span class="px-6 py-2.5 bg-primary hover:bg-primary/90 transition-all text-black font-medium text-center text-sm">
                  Read More â†’
                </span>
              </div>
            </div>
          </a>
        </div>
      )
    }

    <!-- Recent Projects -->
    <div class="mb-12">
      <div class="flex items-center gap-4 mb-8">
        <p class="text-white">
          <span class="text-primary">//</span> recent work
        </p>
        <div class="h-px bg-lines flex-1"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {
          recentProjects.map((project) => (
            <a
              href={`/work/${project.data.slug}`}
              class="group border border-lines hover:border-primary transition-colors overflow-hidden"
            >
              <div class="relative aspect-video overflow-hidden bg-neutral-900">
                {project.data.logo ? (
                  <div class="grid h-full place-items-center bg-white p-6">
                    <img
                      src={project.data.logo}
                      alt={`${project.data.title} logo`}
                      class="max-h-full max-w-full object-contain transition-transform duration-300 group-hover:scale-105"
                      transition:name={`work-image-${project.data.slug}`}
                    />
                  </div>
                ) : project.data.heroImage ? (
                  <img
                    src={project.data.heroImage}
                    alt={`${project.data.title} hero image`}
                    class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                    transition:name={`work-image-${project.data.slug}`}
                  />
                ) : (
                  <div class="grid h-full place-items-center bg-gradient-to-br from-primary/20 to-primary/5">
                    <span class="text-primary/30 text-4xl font-bold">
                      {project.data.title.charAt(0)}
                    </span>
                  </div>
                )}
              </div>

              <div class="p-6">
                <span class="text-foreground-muted text-xs mb-2 block">
                  {project.data.category}
                </span>
                <h3 class="text-xl font-semibold mb-2 group-hover:text-primary transition-colors">
                  {project.data.title}
                </h3>
                <p class="text-foreground-muted text-sm line-clamp-2">
                  {project.data.description}
                </p>
              </div>
            </a>
          ))
        }
      </div>
    </div>

    <!-- View All CTA -->
    <div class="text-center">
      <a
        href="/work"
        class="inline-flex items-center gap-2 px-8 py-3 border border-lines hover:border-primary hover:text-primary transition-all"
      >
        <span>View All Work</span>
        <Arrow class="inline rotate-45 size-4" />
      </a>
    </div>
  </div>
</div>
